Fifi, [12/15/2025 10:16 AM]
{% extends 'shared/base.html' %}
{% block title %}Animals Catalog{% endblock %}

{% block content %}
<style>
    /* Catalog Specific Styles */
    :root {
        --accent: #B08968;
        --bg: #F5F5F5;
        /* This will be overridden by base.html body background */
        --text: #333;
        /* This will be overridden by base.html body color */
        --ok: #27ae60;
        --no: #c0392b;
    }

    /* body styles are now handled by base.html */

    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 20px;
    }

    .card {
        background: rgba(255, 255, 255, 0.8);
        /* Slightly clearer than glass */
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
    }

    .card img {
        width: 100%;
        height: 200px;
        object-fit: cover;
        border-radius: 5px;
        background: #eee;
    }

    .card h3 {
        margin: 10px 0 5px;
    }

    .view-btn {
        display: inline-block;
        margin-top: 10px;
        padding: 8px 16px;
        background: var(--accent);
        color: white;
        text-decoration: none;
        border-radius: 5px;
        cursor: pointer;
        border: none;
        text-align: center;
    }

    .logout {
        color: red;
        cursor: pointer;
    }

    /* Detail Panel Modal Styles */
    .detail-panel {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 2000;
        /* Higher than navbar */
        display: none;
        /* Hidden by default */
        justify-content: center;
        align-items: center;
        overflow-y: auto;
        padding: 20px;
    }

    /* Show when targeted */
    .detail-panel:target {
        display: flex;
    }

    .panel-content {
        background: white;
        padding: 30px;
        border-radius: 15px;
        max-width: 600px;
        width: 100%;
        position: relative;
        max-height: 90vh;
        overflow-y: auto;
    }

    .close-panel {
        position: absolute;
        top: 15px;
        right: 20px;
        font-size: 30px;
        text-decoration: none;
        color: #333;
    }

    .detail-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin: 15px 0;
        background: #f9f9f9;
        padding: 15px;
        border-radius: 8px;
    }

    .status-badge {
        display: inline-block;
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 12px;
        text-transform: uppercase;
        font-weight: bold;
        color: white;
        margin-bottom: 10px;
    }

    .status-available {
        background: var(--ok);
    }

    .status-adopted {
        background: #333;
    }

    .status-pending {
        background: #f39c12;
    }

    .health-tags .tag {
        display: inline-block;
        padding: 4px 8px;
        margin-right: 5px;
        border-radius: 5px;
        font-size: 12px;
        border: 1px solid #ddd;
    }

    .tag.ok {
        color: var(--ok);
        border-color: var(--ok);
        background: #e8f8f5;
    }

    .tag.no {
        color: var(--no);
        border-color: var(--no);
        background: #fdedec;
    }

    .adopt-btn {
        display: block;
        width: 100%;
        padding: 12px;
        background: var(--accent);
        color: white;
        text-align: center;
        border: none;
        cursor: pointer;
        text-decoration: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: bold;
        margin: 15px 0;
    }

    Fifi,
    [12/15/2025 10:16 AM] .disabled-btn {
        display: block;
        width: 100%;
        padding: 12px;
        background: #ccc;
        color: #666;
        text-align: center;
        border-radius: 8px;
        margin: 15px 0;
        cursor: not-allowed;
    }

    .panel-img {
        width: 100%;
        height: 300px;
        object-fit: cover;
        border-radius: 10px;
        margin-bottom: 20px;
    }
</style>

<div class="header">
    <h1>Animals Catalog</h1>
    <div>
        <span id="userInfo"></span>
        <a class="logout" onclick="logout()">Logout</a>
    </div>
</div>

<!-- Grid Container -->
<div class="grid" id="animalsGrid">
    <p>Loading...</p>
</div>

<!-- Modals Container -->
<div id="modalsContainer"></div>


<script>
    const API_URL = '/api/animals/';

    // --- AUTH & COOKIE BRIDGE ---
    const urlParams = new URLSearchParams(window.location.search);
    const tokenFromUrl = urlParams.get('t');
    const userFromUrl = urlParams.get('u');

    if (tokenFromUrl) {
        localStorage.setItem('access_token', tokenFromUrl);
        if (userFromUrl) {
            localStorage.setItem('user_info', userFromUrl);
        }
        window.history.replaceState({}, document.title, window.location.pathname);
    }

    const getCookie = (name) => {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
    };

    const cookieToken = getCookie('access_token');
    const cookieUser = getCookie('user_info');

    if (cookieToken) {
        localStorage.setItem('access_token', cookieToken);
        if (cookieUser) {
            localStorage.setItem('user_info', decodeURIComponent(cookieUser));
        }
        document.cookie = "access_token=; path=/; max-age=0";
        document.cookie = "user_info=; path=/; max-age=0";
    }

    const token = localStorage.getItem('access_token');
    const user = JSON.parse(localStorage.getItem('user_info') || '{}');

    if (!token) {
        window.location.href = 'http://127.0.0.1:8001/login/';
    }

    document.getElementById('userInfo').innerText = 'Hello, ' + (user.first_name || 'User');

    function logout() {
        localStorage.removeItem('access_token');
        localStorage.removeItem('refresh_token');
        window.location.href = 'http://127.0.0.1:8001/login/';
    }

    // --- DATA LOADING ---
    async function loadAnimals() {
        try {
            const response = await fetch(API_URL, {
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            });
            if (!response.ok) {
                throw new Error(`Server returned ${response.status}: ${response.statusText}`);
            }
            const animals = await response.json();
            const grid = document.getElementById('animalsGrid');
            const modals = document.getElementById('modalsContainer');

            grid.innerHTML = '';
            modals.innerHTML = '';

            if (animals.length === 0) {
                grid.innerHTML = '<p>No animals found.</p>';
                return;
            }


            animals.forEach(a => {
                // 1. Render Card
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                        <img src="${a.image || '/static/img/animal-placeholder.jpg'}" alt="${a.name}">
                        <h3>${a.name}</h3>
                        <p class="status-badge status-${a.status}">${a.status}</p>
                        <br>
                        <button class="view-btn" onclick="document.location.hash='#animal-${a.id}'">
                             ü§ç Meet ${a.name}
                        </button>
                    `;
                grid.appendChild(card);

                // 2. Render Detail Modal (Hidden by default, shown by :target)
                const modal = document.createElement('div');
                modal.id = `animal-${a.id}`;
                modal.className = 'detail-panel';

                // Logic for Adopt Button
                let adoptBtnHtml = '';
                if (a.status === 'available') {
                    // User requested link to port 8003 adoption
                    adoptBtnHtml = `
                            <button class="adopt-btn" onclick="goToAdoption(${a.id}, '${a.name.replace(/'/g, "\\'")}')">
                                ü§ç Adopt ${a.name}
                            </button>`;
                } else {
                    adoptBtnHtml = `
                            <div class="disabled-btn">
                                ${a.status.toUpperCase()}
                            </div>`;
                }

                // Defaults
                const breed = a.breed || "Unknown";
                const gender = a.gender || "Not specified";
                const size = a.size || "Medium";
                const desc = a.description || "No description provided.";
                const submittedBy = a.owner_id ? "Shelter/User" : "System";

                // Health Tags
                const vaccTag = `<span class="tag ${a.vaccinated ? 'ok' : 'no'}">üíâ Vaccinated</span>`;
                const sterTag = `<span class="tag ${a.sterilized ? 'ok' : 'no'}">‚úÇÔ∏è Sterilized</span>`;
                const wormTag = `<span class="tag ${a.dewormed ? 'ok' : 'no'}">ü™± Dewormed</span>`;

                modal.innerHTML = `
                        <div class="panel-content">
                            <a href="#" class="close-panel">√ó</a>
                            
                            <img src="${a.image || '/static/img/animal-placeholder.jpg'}" class="panel-img">
                            <h2>${a.name}</h2>
                            <span class="status-badge status-${a.status}">${a.status}</span>

                            ${adoptBtnHtml}

                            <div class="detail-grid">
                                <p><strong>Type:</strong> ${a.species}</p>
                                <p><strong>Breed:</strong> ${breed}</p>
                                <p><strong>Age:</strong> ${a.age}</p>
                                <p><strong>Gender:</strong> ${gender}</p>
                                <p><strong>Size:</strong> ${size}</p>
                                <p><strong>Location:</strong> ${a.location || 'Shelter'}</p>
                            </div>

                            <h4>ü©∫ Health</h4>
                            <div class="health-tags">
                                ${vaccTag} ${sterTag} ${wormTag}
                            </div>

                            ${a.medical_conditions ? `<h4>‚ö†Ô∏è Medical Conditions</h4><p class="medical-box">${a.medical_conditions}</p>` : ''}

                            <h4>üìñ About</h4>
                            <p>${desc}</p>

                            <p class="meta" style="color: #666; font-size: 0.9em; margin-top: 20px;">
                                Submitted by: <strong>${submittedBy}</strong><br>
                                Added on ${new Date(a.created_at || Date.now()).toLocaleDateString()}
                            </p>
                        </div>
                `;
                modals.appendChild(modal);
            });

        } catch (error) {
            console.error(error);
            document.getElementById('animalsGrid').innerText = 'Error loading animals: ' + error.message;
        }
    }

    async function goToAdoption(animalId, animalName) {
        // Cookie Bridge: Set cookie for cross-port transfer to Port 8003
        const token = localStorage.getItem('access_token');
        const user = localStorage.getItem('user_info');

        if (token) {
            document.cookie = `access_token = ${token}; path =/; max-age=60; SameSite=Lax`;
            if (user) document.cookie = `user_info=${encodeURIComponent(user)}; path=/; max-age=60; SameSite=Lax`;
        }

        // Redirect
        window.location.href = `http://127.0.0.1:8003/adoption/create/?animal_id=${animalId}`;
    }

    loadAnimals();
</script>
{% endblock %}