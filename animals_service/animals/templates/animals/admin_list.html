{% extends 'shared/base.html' %}
{% block title %}Admin ‚Äî Animals{% endblock %}

{% block content %}
<style>
    .admin-container {
        max-width: 1000px;
        margin: 0 auto;
        background: white;
        padding: 30px;
        border-radius: 15px;
    }

    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
    }

    .animal-card {
        border-bottom: 1px solid #eee;
        padding: 15px 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .btn-approve {
        background: #27ae60;
        color: white;
        padding: 5px 10px;
        border-radius: 5px;
        cursor: pointer;
        border: none;
    }

    .btn-reject {
        background: #c0392b;
        color: white;
        padding: 5px 10px;
        border-radius: 5px;
        cursor: pointer;
        border: none;
    }

    .status-badge {
        padding: 3px 8px;
        border-radius: 10px;
        font-size: 0.8em;
        background: #eee;
    }
</style>

<div class="admin-container">
    <div class="header">
        <h1>üêæ Inventory Manager</h1>
        <a href="#" onclick="navigateTo('http://127.0.0.1:8001/admin-dashboard/')" style="color: #7F5539;">Back to
            Dashboard</a>
    </div>
    <div id="animalsList">Loading...</div>
    <div id="editModal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center;">
        <div style="background:white; padding:30px; border-radius:12px; width:400px;">
            <h3>Edit Animal</h3>
            <input type="hidden" id="editId">
            <label>Name</label>
            <input type="text" id="editName" style="width:100%; margin-bottom:10px; padding:8px;">
            <label>Species</label>
            <input type="text" id="editSpecies" style="width:100%; margin-bottom:10px; padding:8px;">
            <label>Description</label>
            <textarea id="editDescription" style="width:100%; margin-bottom:10px; padding:8px;"></textarea>

            <div style="display:flex; gap:10px; justify-content:flex-end;">
                <button onclick="closeModal()" style="padding:8px 16px; cursor:pointer;">Cancel</button>
                <button onclick="saveEdit()"
                    style="background:#B08968; color:white; padding:8px 16px; border:none; border-radius:4px; cursor:pointer;">Save</button>
            </div>
        </div>
    </div>
</div>

<script>
    const token = localStorage.getItem('access_token');

    async function loadAnimals() {
        try {
            const response = await fetch('/api/animals/', { headers: { 'Authorization': 'Bearer ' + token } });
            if (!response.ok) throw new Error("Failed to load animals");
            const animals = await response.json();

            let html = '';
            animals.forEach(a => {
                html += `
                    <div class="animal-card">
                        <div>
                            <strong>${a.name}</strong> (${a.species})
                            <span class="status-badge">${a.status}</span>
                        </div>
                        <div class="actions">
                            <button class="btn-approve" style="background:#3498db; margin-right:5px;" onclick='openEdit(${JSON.stringify(a)})'>‚úè Edit</button>
                            ${a.status !== 'available' ? `<button class="btn-approve" onclick="updateStatus(${a.id}, 'approve')">Approve</button>` : ''}
                            <button class="btn-reject" onclick="updateStatus(${a.id}, 'reject')">Delete</button>
                        </div>
                    </div>
                `;
            });
            document.getElementById('animalsList').innerHTML = html;
        } catch (e) {
            document.getElementById('animalsList').innerHTML = `<p style="color:red">${e.message}</p>`;
        }
    }

    async function updateStatus(id, action) {
        if (!confirm("Confirm action?")) return;
        const endpoint = action === 'approve' ? `/api/admin/animals/${id}/approve/` : `/api/admin/animals/${id}/reject/`;
        await fetch(endpoint, {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + token }
        });
        loadAnimals();
    }

    function openEdit(animal) {
        document.getElementById('editId').value = animal.id;
        document.getElementById('editName').value = animal.name;
        document.getElementById('editSpecies').value = animal.species;
        document.getElementById('editDescription').value = animal.description || '';
        document.getElementById('editModal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('editModal').style.display = 'none';
    }

    async function saveEdit() {
        const id = document.getElementById('editId').value;
        const data = {
            name: document.getElementById('editName').value,
            species: document.getElementById('editSpecies').value,
            description: document.getElementById('editDescription').value,
        };

        try {
            const res = await fetch(`/api/animals/${id}/`, {
                method: 'PATCH',
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            if (res.ok) {
                closeModal();
                loadAnimals();
            } else {
                alert("Failed to update");
            }
        } catch (e) { console.error(e); }
    }

    loadAnimals();
</script>
{% endblock %}