{% extends 'shared/base.html' %}
{% block title %}My Notifications{% endblock %}

{% block content %}
<style>
    .glass-panel {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(18px);
        border-radius: 18px;
        padding: 30px;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
        max-width: 800px;
        margin: 0 auto;
    }

    h1 {
        margin-bottom: 30px;
        color: var(--dark-olive);
    }

    .notif-card {
        border-bottom: 1px solid rgba(127, 85, 57, 0.2);
        padding: 15px 0;
        display: flex;
        align-items: flex-start;
        gap: 15px;
    }

    .notif-card:last-child {
        border-bottom: none;
    }

    .icon {
        font-size: 24px;
        background: white;
        padding: 10px;
        border-radius: 50%;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .content h3 {
        margin: 0 0 5px;
        font-size: 1.1em;
        color: var(--brown);
    }

    .content p {
        margin: 0;
        color: var(--text-soft);
        line-height: 1.5;
    }

    .date {
        font-size: 0.8em;
        color: #999;
        margin-top: 5px;
        display: block;
    }
</style>

<div class="glass-panel">
    <h1>ðŸ”” My Notifications</h1>
    <div id="notifList">
        <p>Loading...</p>
    </div>
</div>

<script>
    // Cookie Bridge: Read & Clear Cookie
    function getCookie(name) {
        const v = document.cookie.match('(^|;) ?' + name + '=([^;]*)(;|$)');
        return v ? v[2] : null;
    }
    const cookieToken = getCookie('access_token');
    if (cookieToken) {
        localStorage.setItem('access_token', cookieToken);
        const cookieUser = getCookie('user_info');
        if (cookieUser) {
            localStorage.setItem('user_info', decodeURIComponent(cookieUser));
        }
        // Clear cookies
        document.cookie = "access_token=; path=/; max-age=0";
        document.cookie = "user_info=; path=/; max-age=0";
    }

    const token = localStorage.getItem('access_token');
    if (!token) window.location.href = 'http://127.0.0.1:8001/login/';

    async function loadNotifications() {
        try {
            const response = await fetch('/api/notifications/', {
                headers: { 'Authorization': 'Bearer ' + token }
            });

            if (!response.ok) throw new Error("Failed to load notifications");

            const notifs = await response.json();
            const container = document.getElementById('notifList');
            container.innerHTML = '';

            if (notifs.length === 0) {
                container.innerHTML = '<p>No new notifications.</p>';
                return;
            }

            notifs.forEach(n => {
                const date = new Date(n.created_at).toLocaleString();
                const div = document.createElement('div');
                div.className = 'notif-card';
                div.innerHTML = `
                    <div class="icon">ðŸ’Œ</div>
                    <div class="content">
                        <h3>${n.message}</h3>
                        <p>Status: ${n.read ? 'Read' : 'Unread'}</p>
                        <small class="date">${date}</small>
                    </div>
                `;
                container.appendChild(div);
            });

        } catch (error) {
            document.getElementById('notifList').innerHTML = `<p style="color:red">Error: ${error.message}</p>`;
        }
    }

    loadNotifications();
</script>
{% endblock %}