services:
  traefik:
    image: traefik:v2.10
    command:
      - "--api.insecure=true"
      - "--api.dashboard=true"
      - "--providers.docker=true"
      - "--entrypoints.web.address=:80"
    ports:
      - "80:80"
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - web

  rabbitmq:
    image: rabbitmq:3-management
    ports:
      - "5672:5672"
      - "15672:15672"
    networks:
      - web

  consul:
    image: hashicorp/consul:1.18
    command: ["agent", "-dev", "-client=0.0.0.0"]
    ports:
      - "8500:8500"
    networks:
      - web

  accounts-service:
    build: ./accounts_service
    container_name: accounts-service
    depends_on:
      - rabbitmq
      - consul
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.accounts.rule=Host(`accounts.localhost`)"
      - "traefik.http.routers.accounts.entrypoints=web"
      - "traefik.http.services.accounts.loadbalancer.server.port=8001"
    networks:
      - web

  adoption-service:
    build: ./adoption_service
    container_name: adoption-service
    depends_on:
      - rabbitmq
      - consul
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.adoption.rule=Host(`adoption.localhost`)"
      - "traefik.http.routers.adoption.entrypoints=web"
      - "traefik.http.services.adoption.loadbalancer.server.port=8003"
    networks:
      - web

  animals-service:
    build: ./animals_service
    container_name: animals-service
    depends_on:
      - rabbitmq
      - consul
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.animals.rule=Host(`animals.localhost`)"
      - "traefik.http.routers.animals.entrypoints=web"
      - "traefik.http.services.animals.loadbalancer.server.port=8002"
    networks:
      - web

  appointments-service:
    build: ./appointments_service
    container_name: appointments-service
    depends_on:
      - rabbitmq
      - consul
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.appointments.rule=Host(`appointments.localhost`)"
      - "traefik.http.routers.appointments.entrypoints=web"
      - "traefik.http.services.appointments.loadbalancer.server.port=8004"
    networks:
      - web

networks:
  web:
    driver: bridge
