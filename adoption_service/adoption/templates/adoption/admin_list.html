{% extends 'shared/base.html' %}
{% block title %}Admin ‚Äî Adoptions{% endblock %}

{% block content %}
<style>
    .admin-container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        padding: 30px;
        border-radius: 15px;
    }

    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }

    th,
    td {
        text-align: left;
        padding: 15px;
        border-bottom: 1px solid #eee;
    }

    th {
        color: #888;
        font-weight: 500;
        font-size: 0.9em;
    }

    .btn-approve {
        background: #27ae60;
        color: white;
        padding: 6px 12px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        margin-right: 5px;
    }

    .btn-reject {
        background: #c0392b;
        color: white;
        padding: 6px 12px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
    }

    .status-badge {
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.85em;
        font-weight: bold;
        background: #f0f0f0;
        color: #555;
    }

    .status-pending {
        background: #f39c12;
        color: white;
    }

    .status-approved {
        background: #27ae60;
        color: white;
    }

    .status-rejected {
        background: #c0392b;
        color: white;
    }

    .status-cancelled {
        background: #7f8c8d;
        color: white;
    }
</style>

<div class="admin-container">
    <div class="header">
        <h1>üìÑ Adoption Requests Manager</h1>
        <a href="#" onclick="navigateTo('/accounts/admin-panel/')" style="color: #7F5539; font-weight: bold;">Back to
            Dashboard</a>
    </div>

    <div id="loading">Loading requests...</div>
    <div id="tableContainer" style="display:none;">
        <table id="requestsTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>User ID</th>
                    <th>Animal ID</th>
                    <th>Date</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <!-- Rows injected here -->
            </tbody>
        </table>
    </div>
</div>

<script>
    const token = localStorage.getItem('access_token');

    async function loadRequests() {
        try {
            console.log("Fetching adoption requests...");
            const response = await fetch('/adoption/admin-panel/requests/', {
                headers: { 'Authorization': 'Bearer ' + token }
            });

            if (!response.ok) {
                const txt = await response.text();
                document.getElementById('loading').innerHTML = `<span style="color:red">Access Denied or Server Error: ${response.status}</span><br><small>${txt}</small>`;
                return;
            }

            const requests = await response.json();
            console.log("Requests loaded:", requests);

            if (requests.length === 0) {
                document.getElementById('loading').innerHTML = "No adoption requests found.";
                return;
            }

            document.getElementById('loading').style.display = 'none';
            document.getElementById('tableContainer').style.display = 'block';

            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            requests.forEach(r => {
                let statusClass = 'status-' + r.status.toLowerCase();
                let actions = '-';

                if (r.status === 'pending') {
                    actions = `
                        <button class="btn-approve" onclick="action(${r.id}, 'approve')">‚úÖ Accept</button>
                        <button class="btn-reject" onclick="action(${r.id}, 'reject')">‚ùå Refuse</button>
                    `;
                }

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>#${r.id}</td>
                    <td>${r.user_id}</td>
                    <td>${r.animal_id}</td>
                    <td>${new Date(r.date_requested).toLocaleDateString()}</td>
                    <td><span class="status-badge ${statusClass}">${r.status.toUpperCase()}</span></td>
                    <td>${actions}</td>
                `;
                tbody.appendChild(tr);
            });

        } catch (e) {
            console.error(e);
            document.getElementById('loading').innerHTML = `<span style="color:red">Network Error: ${e.message}</span>`;
        }
    }

    async function action(id, type) {
        if (!confirm(`Are you sure you want to ${type.toUpperCase()} this request?`)) return;

        try {
            // Fix: ensure unified path through Traefik
            const res = await fetch(`/adoption/admin-panel/requests/${id}/${type}/`, {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + token }
            });
            if (res.ok) {
                loadRequests();
            } else {
                alert("Action failed: " + res.status);
            }
        } catch (e) {
            alert("Error: " + e.message);
        }
    }

    loadRequests();
</script>
{% endblock %}